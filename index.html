<!DOCTYPE html>
<html>
<head>
  <title>MusicKit Authorization & Apple Music API</title>
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" async></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
    button { margin: 10px 0; padding: 10px; }
    #status, #library-content { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Apple Music API Demo</h1>
  
  <div id="authorization-section">
    <button id="authorize-btn">Authorize Apple Music</button>
    <button id="unauthorize-btn" disabled>Unauthorize</button>
    <div id="status">Not authorized</div>
  </div>

  <div id="music-actions">
    <button id="search-btn" disabled>Search Albums</button>
    <button id="library-btn" disabled>Load Library Albums</button>
  </div>

  <div id="search-results">
    <h2>Search Results</h2>
    <input type="text" id="search-input" placeholder="Enter search term">
    <div id="search-content"></div>
  </div>

  <div id="library-content">
    <h2>My Library Albums</h2>
    <div id="library-albums"></div>
  </div>

  <script>
    document.addEventListener('musickitloaded', async function() {
      const authorizeBtn = document.getElementById('authorize-btn');
      const unauthorizeBtn = document.getElementById('unauthorize-btn');
      const statusDiv = document.getElementById('status');
      const searchBtn = document.getElementById('search-btn');
      const libraryBtn = document.getElementById('library-btn');
      const searchInput = document.getElementById('search-input');
      const searchContent = document.getElementById('search-content');
      const libraryAlbums = document.getElementById('library-albums');
      
      // Fetch MusicKit Developer Token from serverless function
      try {
        const response = await fetch('/.netlify/functions/get-musickit-token');
        const data = await response.json();
        
        // Configure MusicKit
        const music = await MusicKit.configure({
          developerToken: data.token,
          app: {
            name: 'My Apple Music Web App',
            build: '1.0.0',
          }
        });
        
        // Check initial authorization status
        function updateAuthorizationUI() {
          if (music.isAuthorized) {
            statusDiv.textContent = 'Authorized';
            authorizeBtn.disabled = true;
            unauthorizeBtn.disabled = false;
            searchBtn.disabled = false;
            libraryBtn.disabled = false;
          } else {
            statusDiv.textContent = 'Not authorized';
            authorizeBtn.disabled = false;
            unauthorizeBtn.disabled = true;
            searchBtn.disabled = true;
            libraryBtn.disabled = true;
          }
        }
        
        updateAuthorizationUI();
        
        // Authorization Handler
        authorizeBtn.addEventListener('click', async function() {
          try {
            await music.authorize();
            updateAuthorizationUI();
            statusDiv.textContent = 'Authorization successful';
          } catch (error) {
            statusDiv.textContent = 'Authorization failed: ' + error;
          }
        });
        
        // Unauthorization Handler
        unauthorizeBtn.addEventListener('click', async function() {
          try {
            await music.unauthorize();
            updateAuthorizationUI();
            statusDiv.textContent = 'Unauthorization successful';
            searchContent.innerHTML = '';
            libraryAlbums.innerHTML = '';
          } catch (error) {
            statusDiv.textContent = 'Unauthorization failed: ' + error;
          }
        });
        
        // Search Albums Handler
        searchBtn.addEventListener('click', async function() {
          const searchTerm = searchInput.value.trim();
          if (!searchTerm) {
            searchContent.innerHTML = 'Please enter a search term';
            return;
          }
          
          try {
            const result = await music.api.music(
              `/v1/catalog/us/search`,
              { 
                term: searchTerm, 
                types: 'albums',
                limit: 10 
              }
            );
            
            // Render search results
            searchContent.innerHTML = result.data.results.albums.data.map(album => `
              <div>
                <h3>${album.attributes.name}</h3>
                <p>Artist: ${album.attributes.artistName}</p>
                <p>Release Date: ${album.attributes.releaseDate}</p>
              </div>
            `).join('');
          } catch (error) {
            searchContent.innerHTML = 'Search failed: ' + error;
          }
        });
        
        // Load Library Albums Handler
        libraryBtn.addEventListener('click', async function() {
          try {
            // Ensure authorization before accessing library
            await music.authorize();
            
            const result = await music.api.music('v1/me/library/albums');
            
            // Render library albums
            libraryAlbums.innerHTML = result.data.data.map(album => `
              <div>
                <h3>${album.attributes.name}</h3>
                <p>Artist: ${album.attributes.artistName}</p>
              </div>
            `).join('');
          } catch (error) {
            libraryAlbums.innerHTML = 'Failed to load library: ' + error;
          }
        });
      } catch (error) {
        statusDiv.textContent = 'Error initializing MusicKit: ' + error;
      }
    });
  </script>
</body>
</html>