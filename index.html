<!DOCTYPE html>
<html>
<head>
  <title>MusicKit Player & Apple Music API</title>
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    button { margin: 10px 5px; padding: 10px; }
    #status, #library-content, #player-controls { margin: 10px 0; }
    #player-controls { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px;
    }
    #current-track { text-align: center; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Apple Music API Demo</h1>
  
  <div id="authorization-section">
    <button id="authorize-btn">Authorize Apple Music</button>
    <button id="unauthorize-btn" disabled>Unauthorize</button>
    <div id="status">Not initialized</div>
  </div>

  <div id="music-actions">
    <button id="search-btn" disabled>Search Albums</button>
    <button id="library-btn" disabled>Load Library Albums</button>
  </div>

  <div id="search-results">
    <h2>Search Results</h2>
    <input type="text" id="search-input" placeholder="Enter search term">
    <div id="search-content"></div>
  </div>

  <div id="library-content">
    <h2>My Library Albums</h2>
    <div id="library-albums"></div>
  </div>

  <div id="player-section">
    <h2>Music Player</h2>
    <div id="current-track">No track selected</div>
    <div id="player-controls">
      <button id="previous-btn" disabled>⏮️ Previous</button>
      <button id="play-pause-btn" disabled>▶️ Play</button>
      <button id="next-btn" disabled>⏭️ Next</button>
    </div>
    <div id="player-settings">
      <label>
        Volume: 
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
      </label>
      <label>
        Playback Rate: 
        <select id="playback-rate">
          <option value="0.5">0.5x</option>
          <option value="1" selected>1x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
      </label>
      <label>
        Shuffle: 
        <input type="checkbox" id="shuffle-toggle">
      </label>
    </div>
  </div>

  <script>
    // Declare variables outside to ensure they're in the global scope
    let musicKit;
    let player;

    // MusicKit configuration
    document.addEventListener('musickitloaded', function() {
      const statusDiv = document.getElementById('status');
      const authorizeBtn = document.getElementById('authorize-btn');
      const unauthorizeBtn = document.getElementById('unauthorize-btn');
      const searchBtn = document.getElementById('search-btn');
      const libraryBtn = document.getElementById('library-btn');

      // UI Elements
      const searchInput = document.getElementById('search-input');
      const searchContent = document.getElementById('search-content');
      const libraryAlbums = document.getElementById('library-albums');
      const currentTrackDiv = document.getElementById('current-track');
      const previousBtn = document.getElementById('previous-btn');
      const playPauseBtn = document.getElementById('play-pause-btn');
      const nextBtn = document.getElementById('next-btn');
      const volumeSlider = document.getElementById('volume-slider');
      const playbackRateSelect = document.getElementById('playback-rate');
      const shuffleToggle = document.getElementById('shuffle-toggle');

      // Function to fetch developer token
      async function fetchDeveloperToken() {
        try {
          const response = await fetch('/.netlify/functions/get-musickit-token');
          const data = await response.json();
          return data.token;
        } catch (error) {
          statusDiv.textContent = 'Error fetching token: ' + error;
          throw error;
        }
      }

      // Initialize MusicKit
      async function initializeMusicKit() {
        try {
          const developerToken = await fetchDeveloperToken();

          // Configure MusicKit
          musicKit = await MusicKit.configure({
            developerToken: developerToken,
            app: {
              name: 'My Apple Music Web App',
              build: '1.0.0',
            }
          });

          // Get player instance
          player = musicKit.player;

          // Update UI on initialization
          statusDiv.textContent = 'MusicKit Initialized';
          setupEventListeners();
          updateAuthorizationUI();
        } catch (error) {
          statusDiv.textContent = 'Error initializing MusicKit: ' + error;
          console.error(error);
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        // Update current track
        function updateCurrentTrack() {
          const nowPlayingItem = player.nowPlayingItem;
          if (nowPlayingItem) {
            currentTrackDiv.innerHTML = `
              <strong>${nowPlayingItem.title}</strong><br>
              ${nowPlayingItem.artistName} - ${nowPlayingItem.albumName}
            `;
          } else {
            currentTrackDiv.textContent = 'No track playing';
          }
        }

        // Player event listeners
        player.addEventListener('mediaItemDidChange', updateCurrentTrack);
        player.addEventListener('playbackStateDidChange', () => {
          playPauseBtn.textContent = player.isPlaying ? '⏸️ Pause' : '▶️ Play';
        });

        // Volume Control
        volumeSlider.addEventListener('input', (e) => {
          player.volume = parseFloat(e.target.value);
        });

        // Playback Rate Control
        playbackRateSelect.addEventListener('change', (e) => {
          player.playbackRate = parseFloat(e.target.value);
        });

        // Shuffle Toggle
        shuffleToggle.addEventListener('change', (e) => {
          player.shuffle = e.target.checked;
        });

        // Previous, Play/Pause, Next Buttons
        previousBtn.addEventListener('click', () => player.skipToPreviousItem());
        nextBtn.addEventListener('click', () => player.skipToNextItem());
        playPauseBtn.addEventListener('click', () => {
          if (player.isPlaying) {
            player.pause();
          } else {
            player.play();
          }
        });
      }

      // Update UI based on authorization
      function updateAuthorizationUI() {
        if (musicKit.isAuthorized) {
          statusDiv.textContent = 'Authorized';
          authorizeBtn.disabled = true;
          unauthorizeBtn.disabled = false;
          searchBtn.disabled = false;
          libraryBtn.disabled = false;
          
          // Enable player controls
          previousBtn.disabled = false;
          playPauseBtn.disabled = false;
          nextBtn.disabled = false;
        } else {
          statusDiv.textContent = 'Not authorized';
          authorizeBtn.disabled = false;
          unauthorizeBtn.disabled = true;
          searchBtn.disabled = true;
          libraryBtn.disabled = true;
          
          // Disable player controls
          previousBtn.disabled = true;
          playPauseBtn.disabled = true;
          nextBtn.disabled = true;
        }
      }

      // Authorization Handlers
      authorizeBtn.addEventListener('click', async () => {
        try {
          await musicKit.authorize();
          updateAuthorizationUI();
          statusDiv.textContent = 'Authorization successful';
        } catch (error) {
          statusDiv.textContent = 'Authorization failed: ' + error;
        }
      });

      unauthorizeBtn.addEventListener('click', async () => {
        try {
          await musicKit.unauthorize();
          updateAuthorizationUI();
          statusDiv.textContent = 'Unauthorization successful';
          searchContent.innerHTML = '';
          libraryAlbums.innerHTML = '';
          currentTrackDiv.textContent = 'No track playing';
        } catch (error) {
          statusDiv.textContent = 'Unauthorization failed: ' + error;
        }
      });

      // Search Albums Handler
      searchBtn.addEventListener('click', async () => {
        const searchTerm = searchInput.value.trim();
        if (!searchTerm) {
          searchContent.innerHTML = 'Please enter a search term';
          return;
        }
        
        try {
          const result = await musicKit.api.music(
            `/v1/catalog/us/search`,
            { 
              term: searchTerm, 
              types: 'albums',
              limit: 10 
            }
          );
          
          // Render search results with play buttons
          searchContent.innerHTML = result.data.results.albums.data.map(album => `
            <div>
              <h3>${album.attributes.name}</h3>
              <p>Artist: ${album.attributes.artistName}</p>
              <p>Release Date: ${album.attributes.releaseDate}</p>
              <button onclick="playAlbum('${album.id}')">Play Album</button>
            </div>
          `).join('');
        } catch (error) {
          searchContent.innerHTML = 'Search failed: ' + error;
        }
      });

      // Library Albums Handler
      libraryBtn.addEventListener('click', async () => {
        try {
          // Ensure authorization before accessing library
          await musicKit.authorize();
          
          const result = await musicKit.api.library.albums({ limit: 25, offset: 0 });
          
          // Render library albums with play buttons
          libraryAlbums.innerHTML = result.data.data.map(album => `
            <div>
              <h3>${album.attributes.name}</h3>
              <p>Artist: ${album.attributes.artistName}</p>
              <button onclick="playLibraryAlbum('${album.id}')">Play Album</button>
            </div>
          `).join('');
        } catch (error) {
          libraryAlbums.innerHTML = 'Failed to load library: ' + error;
        }
      });

      // Global play functions
      window.playAlbum = async (albumId) => {
        try {
          await musicKit.setQueue({ album: albumId });
          await player.play();
        } catch (error) {
          console.error('Error playing album:', error);
        }
      };

      window.playLibraryAlbum = async (albumId) => {
        try {
          await musicKit.setQueue({ library: albumId });
          await player.play();
        } catch (error) {
          console.error('Error playing library album:', error);
        }
      };

      // Initialize MusicKit when page loads
      initializeMusicKit();
    });
  </script>
</body>
</html>