<!DOCTYPE html>
<html>
<head>
  <title>MusicKit Player & Apple Music API</title>
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" async></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    button { margin: 10px 5px; padding: 10px; }
    #status, #library-content, #player-controls { margin: 10px 0; }
    #player-controls { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px;
    }
    #current-track { text-align: center; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Apple Music API Demo</h1>
  
  <div id="authorization-section">
    <button id="authorize-btn">Authorize Apple Music</button>
    <button id="unauthorize-btn" disabled>Unauthorize</button>
    <div id="status">Not authorized</div>
  </div>

  <div id="music-actions">
    <button id="search-btn" disabled>Search Albums</button>
    <button id="library-btn" disabled>Load Library Albums</button>
  </div>

  <div id="search-results">
    <h2>Search Results</h2>
    <input type="text" id="search-input" placeholder="Enter search term">
    <div id="search-content"></div>
  </div>

  <div id="library-content">
    <h2>My Library Albums</h2>
    <div id="library-albums"></div>
  </div>

  <div id="player-section">
    <h2>Music Player</h2>
    <div id="current-track">No track selected</div>
    <div id="player-controls">
      <button id="previous-btn" disabled>⏮️ Previous</button>
      <button id="play-pause-btn" disabled>▶️ Play</button>
      <button id="next-btn" disabled>⏭️ Next</button>
    </div>
    <div id="player-settings">
      <label>
        Volume: 
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
      </label>
      <label>
        Playback Rate: 
        <select id="playback-rate">
          <option value="0.5">0.5x</option>
          <option value="1" selected>1x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
      </label>
      <label>
        Shuffle: 
        <input type="checkbox" id="shuffle-toggle">
      </label>
    </div>
  </div>

  <script>
    document.addEventListener('musickitloaded', async function() {
      const authorizeBtn = document.getElementById('authorize-btn');
      const unauthorizeBtn = document.getElementById('unauthorize-btn');
      const statusDiv = document.getElementById('status');
      const searchBtn = document.getElementById('search-btn');
      const libraryBtn = document.getElementById('library-btn');
      const searchInput = document.getElementById('search-input');
      const searchContent = document.getElementById('search-content');
      const libraryAlbums = document.getElementById('library-albums');
      
      // Player Controls
      const currentTrackDiv = document.getElementById('current-track');
      const previousBtn = document.getElementById('previous-btn');
      const playPauseBtn = document.getElementById('play-pause-btn');
      const nextBtn = document.getElementById('next-btn');
      const volumeSlider = document.getElementById('volume-slider');
      const playbackRateSelect = document.getElementById('playback-rate');
      const shuffleToggle = document.getElementById('shuffle-toggle');
      
      // Fetch MusicKit Developer Token from serverless function
      try {
        const response = await fetch('/.netlify/functions/get-musickit-token');
        const data = await response.json();
        
        // Configure MusicKit
        const music = await MusicKit.configure({
          developerToken: data.token,
          app: {
            name: 'My Apple Music Web App',
            build: '1.0.0',
          }
        });
        
        // Player Setup
        const player = music.player;
        
        // Update UI based on current track
        function updateCurrentTrack() {
          const nowPlayingItem = player.nowPlayingItem;
          if (nowPlayingItem) {
            currentTrackDiv.innerHTML = `
              <strong>${nowPlayingItem.title}</strong><br>
              ${nowPlayingItem.artistName} - ${nowPlayingItem.albumName}
            `;
          } else {
            currentTrackDiv.textContent = 'No track playing';
          }
        }
        
        // Player Event Listeners
        player.addEventListener('mediaItemDidChange', updateCurrentTrack);
        player.addEventListener('playbackStateDidChange', () => {
          playPauseBtn.textContent = player.isPlaying ? '⏸️ Pause' : '▶️ Play';
        });
        
        // Volume Control
        volumeSlider.addEventListener('input', (e) => {
          player.volume = parseFloat(e.target.value);
        });
        
        // Playback Rate Control
        playbackRateSelect.addEventListener('change', (e) => {
          player.playbackRate = parseFloat(e.target.value);
        });
        
        // Shuffle Toggle
        shuffleToggle.addEventListener('change', (e) => {
          player.shuffle = e.target.checked;
        });
        
        // Previous, Play/Pause, Next Buttons
        previousBtn.addEventListener('click', () => player.skipToPreviousItem());
        nextBtn.addEventListener('click', () => player.skipToNextItem());
        playPauseBtn.addEventListener('click', () => {
          if (player.isPlaying) {
            player.pause();
          } else {
            player.play();
          }
        });
        
        // Check initial authorization status
        function updateAuthorizationUI() {
          if (music.isAuthorized) {
            statusDiv.textContent = 'Authorized';
            authorizeBtn.disabled = true;
            unauthorizeBtn.disabled = false;
            searchBtn.disabled = false;
            libraryBtn.disabled = false;
            
            // Enable player controls
            previousBtn.disabled = false;
            playPauseBtn.disabled = false;
            nextBtn.disabled = false;
          } else {
            statusDiv.textContent = 'Not authorized';
            authorizeBtn.disabled = false;
            unauthorizeBtn.disabled = true;
            searchBtn.disabled = true;
            libraryBtn.disabled = true;
            
            // Disable player controls
            previousBtn.disabled = true;
            playPauseBtn.disabled = true;
            nextBtn.disabled = true;
          }
        }
        
        updateAuthorizationUI();
        
        // Authorization Handler
        authorizeBtn.addEventListener('click', async function() {
          try {
            await music.authorize();
            updateAuthorizationUI();
            statusDiv.textContent = 'Authorization successful';
          } catch (error) {
            statusDiv.textContent = 'Authorization failed: ' + error;
          }
        });
        
        // Unauthorization Handler
        unauthorizeBtn.addEventListener('click', async function() {
          try {
            await music.unauthorize();
            updateAuthorizationUI();
            statusDiv.textContent = 'Unauthorization successful';
            searchContent.innerHTML = '';
            libraryAlbums.innerHTML = '';
            currentTrackDiv.textContent = 'No track playing';
          } catch (error) {
            statusDiv.textContent = 'Unauthorization failed: ' + error;
          }
        });
        
        // Search Albums Handler
        searchBtn.addEventListener('click', async function() {
          const searchTerm = searchInput.value.trim();
          if (!searchTerm) {
            searchContent.innerHTML = 'Please enter a search term';
            return;
          }
          
          try {
            const result = await music.api.music(
              `/v1/catalog/us/search`,
              { 
                term: searchTerm, 
                types: 'albums',
                limit: 10 
              }
            );
            
            // Render search results with play buttons
            searchContent.innerHTML = result.data.results.albums.data.map(album => `
              <div>
                <h3>${album.attributes.name}</h3>
                <p>Artist: ${album.attributes.artistName}</p>
                <p>Release Date: ${album.attributes.releaseDate}</p>
                <button onclick="playAlbum('${album.id}')">Play Album</button>
              </div>
            `).join('');
            
            // Make playAlbum function global
            window.playAlbum = async (albumId) => {
              try {
                await music.setQueue({ album: albumId });
                await player.play();
              } catch (error) {
                console.error('Error playing album:', error);
              }
            };
          } catch (error) {
            searchContent.innerHTML = 'Search failed: ' + error;
          }
        });
        
        // Load Library Albums Handler
        libraryBtn.addEventListener('click', async function() {
          try {
            // Ensure authorization before accessing library
            await music.authorize();
            
            const result = await music.api.library.albums({ limit: 25, offset: 0 });
            
            // Render library albums with play buttons
            libraryAlbums.innerHTML = result.data.data.map(album => `
              <div>
                <h3>${album.attributes.name}</h3>
                <p>Artist: ${album.attributes.artistName}</p>
                <button onclick="playLibraryAlbum('${album.id}')">Play Album</button>
              </div>
            `).join('');
            
            // Make playLibraryAlbum function global
            window.playLibraryAlbum = async (albumId) => {
              try {
                await music.setQueue({ library: albumId });
                await player.play();
              } catch (error) {
                console.error('Error playing library album:', error);
              }
            };
          } catch (error) {
            libraryAlbums.innerHTML = 'Failed to load library: ' + error;
          }
        });
      } catch (error) {
        statusDiv.textContent = 'Error initializing MusicKit: ' + error;
      }
    });
  </script>
</body>
</html>